# FFT-ocean-baker  
FFT（高速フーリエ変換）を使った統計的な波形合成により、画像を出力するツールです。  
3種類のテクスチャ画像：height（波の高さ）、normal（法線）、form（白波）を60枚ずつpngファイルで生成します。  
これらの画像を頂点シェーダーとピクセルシェーダーで処理することで、リアルな波が動く様子を再現できます。
## 作った経緯
現実の波が流れるような表現をweb上でしたいと思ったことがきっかけです。  
後述しますが、FFT oceanはクオリティの高い波を再現できる代わりに計算量がとてつもないです。  
それを踏まえてweb上で動作させるにあたり、3種類の方法を思いつきました。
1. ローカルで波を映像化した様子を録画し、動画ファイルをweb上で流す
2. web上でシミュレーションしたものをそのまま表示する
3. ローカルで映像化に必要なベイクテクスチャを生成して、web上で映像化する

今回は波の表現の自由さやweb上での動作などを考慮して、3の方法を選びました。
## FFT Oceanとゲルストナー波  
FFT oceanと比較される手法として、ゲルストナー波（Gerstner Waves）があります。 

ゲルストナー波は少ない数の波を合成して、水面の頂点を移動させる手法です。  
複数の正弦波の重ね合わせで表現され、規則的に波が生み出されます。  
数学的な構造はシンプルで計算負荷が軽いという特徴がある一方、複雑な波の表現に適していないためリアリティに欠けます。  

対してFFT oceanは、実際の海を観測して得た統計モデルをもとに周波数領域で波を生成し、空間領域へ変換する手法です。  
正確な波を再現できるというかなりのメリットの反面、リアルタイムで表示するにはGPUの計算がほぼ必須なほど高負荷です。  
そこで、web上で動作させるにあたって3種類の方法を思いつきました。
1. ローカルで波を映像化した様子を録画し、動画ファイルをweb上で流す
2. web上でシミュレーションしたものをそのまま表示する
3. ローカルで映像化に必要なベイクテクスチャを生成して、web上で映像化する

表現の自由さやweb上での動作などを考慮して、今回は3の方法を選びました。

## 構成ディレクトリ
```
FFT-ocean-baker/
├── CMakeLists.txt          # ビルド設定ファイル
├── src/                    # ソースコードディレクトリ
│   ├── main.cpp            # エントリーポイント：シミュレーションループと画像出力
│   ├── ocean/              # シミュレーションのメインディレクトリ
│   │   ├── simulator.cpp   # FFTで波形生成・更新
│   │   └── simulator.hpp   # OceanSimulatorクラスの定義
│   └── utils/              # ユーティリティディレクトリ
│       ├── image_writer.cpp# 各テクスチャのpng保存処理
│       └── image_writer.hpp# 画像保存関数のプロトタイプ宣言
├── output/                 # テクスチャの出力先
└── build/                  # ビルドディレクトリ
```
## 使い方
### 利用環境
- **言語：** C++17以上
- **外部パッケージ：** FFTW3
- **ビルドシステム：** CMake 3.10+
### パッケージインストールとビルド  
**注意：** vcpkgを使ったFFTW3の導入を想定しています
1. ``` vcpkg install fftw3:x64-windows ```
2. ```CMakeLists.txt```内の```VCPKG_INCLUDE_DIR```と```VCPKG_LIB_DIR```を、自身の環境のパスに修正
3. 以下のコマンドを実行します
```
mkdir build
cd build
cmake ..
cmake --build . --config Release
```
### 実行方法
```
cd Release
./ocean_baker.exe
```
### 実行結果
outputフォルダ内に3種類のテクスチャ画像が生成されます。
1. height_*.png: 波の高さマップ
2. normal_*.png: 法線マップ
3. foam_*.png: 白波（フォーム）マップ

